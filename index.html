<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…ÙƒØªØ¨ ØªØ­ÙÙŠØ¸ Ø§Ù„Ø´ÙŠØ® Ø³Ø¹Ø¯ Ø¨Ù† Ù…Ø­Ù…ÙˆØ¯ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ø±Ø¬</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#26ac68',
              secondary: '#147a3d',
              accent: '#ff9800',
              danger: '#f44336',
              bgStart: '#f5efe6',
              bgEnd: '#c0e6c9',
            },
            fontFamily: {
              amiri: ['Amiri', 'serif'],
            },
          }
        }
      }
    </script>
    
    <style>
      body { font-family: 'Amiri', serif; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
      @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
      .animate-fade-in { animation: fade-in-up 0.3s ease-out forwards; }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration File -->
    <script src="firebase-config.js"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "recharts": "https://esm.sh/recharts@2.10.3"
      }
    }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gradient-to-br from-bgStart to-bgEnd min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        User, FileText, Users, Download, Settings, Lock, 
        UserCheck, UserX, Trash2, Eye, Key, LogOut, 
        Settings as SettingsIcon, Check, X, UserPlus, 
        Save, History, BookOpen 
      } from 'lucide-react';
      import { 
        BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer 
      } from 'recharts';

      // ==========================================
      // SERVICES & API (Cloud Firestore)
      // ==========================================
      
      // Access global config and db initialized in firebase-config.js
      const firebaseConfig = window.firebaseConfig || {};
      
      // Initialize db reference (assuming firebase is initialized in firebase-config.js)
      let db;
      try {
        db = firebase.firestore();
      } catch (error) {
        console.error("Firestore Init Error (Ensure firebase-config.js is loaded):", error);
      }
      
      // Helper to map Firestore snapshot
      const mapSnapshot = (snap) => snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const api = {
        getAdminPassword: async () => {
          try {
            const doc = await db.collection('settings').doc('admin').get();
            return doc.exists ? doc.data().password : 'admin2025';
          } catch { return 'admin2025'; }
        },
        setAdminPassword: async (password) => {
          await db.collection('settings').doc('admin').set({ password }, { merge: true });
        },
        
        getTeachers: async () => {
          try {
            const snap = await db.collection('teachers').get();
            const teachersArr = mapSnapshot(snap);
            // Convert array to object key-map for easier lookup
            const teachersObj = {};
            teachersArr.forEach(t => { teachersObj[t.code] = t; });
            return teachersObj;
          } catch (e) { console.error(e); return {}; }
        },
        saveTeacher: async (teacher) => {
          // Use 'code' as document ID to prevent duplicates easily
          await db.collection('teachers').doc(teacher.code).set(teacher);
        },
        deleteTeacher: async (code) => {
          await db.collection('teachers').doc(code).delete();
        },

        getStudents: async () => {
          try {
            const snap = await db.collection('students').get();
            return mapSnapshot(snap);
          } catch { return []; }
        },
        registerStudent: async (student) => {
          // Use code as ID if unique, or auto-ID. Using student.id from frontend logic here
          await db.collection('students').doc(student.id.toString()).set(student);
        },
        updateStudent: async (student) => {
          await db.collection('students').doc(student.id.toString()).update(student);
        },
        deleteStudent: async (id) => {
          await db.collection('students').doc(id.toString()).delete();
        },

        getAttendance: async () => {
          try {
            const snap = await db.collection('attendance').get();
            return mapSnapshot(snap);
          } catch { return []; }
        },
        saveAttendanceBatch: async (records) => {
          const batch = db.batch();
          records.forEach(rec => {
            const ref = db.collection('attendance').doc(); // Auto ID
            batch.set(ref, rec);
          });
          await batch.commit();
        },

        getStudentLogs: async (studentCode) => {
          try {
            const snap = await db.collection('logs').where('studentCode', '==', studentCode).get();
            return mapSnapshot(snap);
          } catch { return []; }
        },
        saveStudentLog: async (studentCode, record) => {
          await db.collection('logs').add({ ...record, studentCode });
        },

        // Helper for exporting data (fetch all collections)
        exportData: async () => {
          const tSnap = await db.collection('teachers').get();
          const sSnap = await db.collection('students').get();
          const aSnap = await db.collection('attendance').get();
          const lSnap = await db.collection('logs').get();
          
          return {
            teachers: mapSnapshot(tSnap),
            students: mapSnapshot(sSnap),
            attendance: mapSnapshot(aSnap),
            studentLogs: mapSnapshot(lSnap)
          };
        }
      };

      // ==========================================
      // UI COMPONENTS
      // ==========================================
      
      const Button = ({ children, variant = 'primary', fullWidth = false, className = '', ...props }) => {
        const baseStyles = "py-3 px-6 rounded-xl font-bold transition-all duration-300 transform hover:scale-[1.02] shadow-md disabled:opacity-50 disabled:cursor-not-allowed";
        const variants = {
          primary: "bg-primary text-white hover:bg-secondary",
          secondary: "bg-gray-200 text-gray-800 hover:bg-gray-300",
          danger: "bg-danger text-white hover:bg-red-700",
          accent: "bg-accent text-white hover:bg-orange-600",
          purple: "bg-purple-600 text-white hover:bg-purple-700",
          pink: "bg-pink-500 text-white hover:bg-pink-600",
        };
        return (
          <button className={`${baseStyles} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`} {...props}>
            {children}
          </button>
        );
      };

      const Card = ({ children, className = '', title }) => (
        <div className={`bg-white rounded-2xl shadow-[0_2px_12px_rgba(80,180,82,0.1)] p-6 md:p-8 ${className}`}>
          {title && <h2 className="text-2xl md:text-3xl font-bold text-secondary mb-6 text-center">{title}</h2>}
          {children}
        </div>
      );

      const Input = ({ label, className = '', ...props }) => (
        <div className="mb-4">
          <label className="block text-gray-700 font-medium mb-2 text-right">{label}</label>
          <input className={`w-full p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-right ${className}`} {...props} />
        </div>
      );

      const Select = ({ label, children, ...props }) => (
        <div className="mb-4">
          <label className="block text-gray-700 font-medium mb-2 text-right">{label}</label>
          <select className="w-full p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all text-right bg-white" {...props}>
            {children}
          </select>
        </div>
      );

      const StatCard = ({ label, value, colorClass = "text-primary", icon: Icon }) => (
        <div className="bg-white rounded-2xl p-6 shadow-sm flex flex-col items-center justify-center text-center">
          {Icon && <Icon className={`w-8 h-8 mb-2 ${colorClass}`} />}
          <div className="text-gray-500 text-sm mb-1">{label}</div>
          <div className={`text-3xl font-bold ${colorClass}`}>{value}</div>
        </div>
      );

      // ==========================================
      // VIEWS
      // ==========================================

      // --- HOME ---
      const Home = ({ onNavigate }) => {
        return (
          <div className="flex flex-col items-center justify-center min-h-[70vh] px-4">
            <div className="text-center mb-8 animate-fade-in-up">
              <p className="text-xl text-primary font-bold mb-6">Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ â˜ºï¸</p>
              <div className="space-y-2 text-gray-800 text-lg md:text-xl font-medium max-w-2xl mx-auto leading-relaxed">
                <p>Ù„ÙØ¹ÙÙ„ÙÙ‘ Ø¥ÙÙ„Ù‡Ù Ø§Ù„Ù’Ø¹ÙØ±Ù’Ø´Ù ÙŠÙØ§ Ø¥ÙØ®Ù’ÙˆÙØªÙÙŠ ÙŠÙÙ‚ÙÙŠ ... Ø¬ÙÙ…ÙØ§Ø¹ÙØªÙÙ†ÙØ§ ÙƒÙÙ„ÙÙ‘ Ø§Ù„Ù…ÙÙƒØ§ÙØ±ÙÙ‡Ù Ù‡ÙÙˆÙÙ‘Ù„ÙØ§</p>
                <p>ÙˆÙÙŠÙØ¬Ù’Ø¹ÙÙ„ÙÙ†ÙØ§ Ù…ÙÙ…ÙÙ‘Ù†Ù’ ÙŠÙÙƒÙÙˆÙ†Ù ÙƒÙØªØ§ÙØ¨ÙÙ‡Ù ... Ø´ÙÙÙÙŠØ¹Ù‹Ø§ Ù„ÙÙ‡ÙÙ…Ù’ Ø¥ÙØ°Ù’ Ù…ÙØ§ Ù†ÙØ³ÙÙˆÙ’Ù‡Ù ÙÙÙŠÙ…Ù’Ø­ÙÙ„ÙØ§</p>
              </div>
            </div>
            <div className="w-full max-w-md">
              <Card className="animate-fade-in-up delay-100">
                <p className="text-center text-gray-800 mb-6 leading-relaxed">
                  Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ÙƒØªØ¨ <br/> Ø¨Ø´ÙƒÙ„ Ø±Ù‚Ù…ÙŠ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.
                </p>
                <div className="space-y-3">
                  <Button fullWidth onClick={() => onNavigate('LOGIN_TEACHER')}>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</Button>
                  <Button fullWidth variant="purple" onClick={() => onNavigate('LOGIN_ADMIN')}>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</Button>
                  <Button fullWidth variant="pink" onClick={() => onNavigate('LOGIN_STUDENT')}>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</Button>
                  <Button fullWidth variant="accent" onClick={() => onNavigate('REGISTER_STUDENT')}>ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</Button>
                </div>
              </Card>
            </div>
          </div>
        );
      };

      // --- LOGIN ---
      const Login = ({ view, onNavigate, onLoginSuccess }) => {
        const [formData, setFormData] = useState({ code: '', password: '', name: '', confirmPassword: '' });
        const [error, setError] = useState('');
        const [success, setSuccess] = useState('');
        const [loading, setLoading] = useState(false);

        const handleChange = (e) => {
          setFormData({ ...formData, [e.target.name]: e.target.value });
          setError('');
        };

        const handleAdminLogin = async () => {
          setLoading(true);
          const realPwd = await api.getAdminPassword();
          if (formData.password === realPwd) {
            onLoginSuccess('admin');
          } else {
            setError('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
          }
          setLoading(false);
        };

        const handleTeacherLogin = async () => {
          setLoading(true);
          const teachers = await api.getTeachers();
          const teacher = teachers[formData.code];
          if (teacher && teacher.password === formData.password) {
            onLoginSuccess('teacher', teacher);
          } else {
            setError('Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£');
          }
          setLoading(false);
        };

        const handleStudentLogin = async () => {
          setLoading(true);
          const students = await api.getStudents();
          const student = students.find(s => s.code === formData.code && s.password === formData.password);
          if (student) {
            onLoginSuccess('student', student);
          } else {
            setError('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
          }
          setLoading(false);
        };

        const handleStudentRegister = async () => {
          if (!formData.name || !formData.code || !formData.password) return setError('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          if (formData.password !== formData.confirmPassword) return setError('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
          setLoading(true);
          const students = await api.getStudents();
          if (students.some(s => s.code === formData.code)) {
            setLoading(false);
            return setError('Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„');
          }

          await api.registerStudent({
            id: Date.now().toString(),
            name: formData.name,
            code: formData.code,
            password: formData.password,
            class: 'Ø¬Ø¯ÙŠØ¯',
            registrationDate: new Date().toISOString()
          });

          setSuccess('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...');
          setTimeout(() => onNavigate('LOGIN_STUDENT'), 1500);
        };

        const titles = {
          'LOGIN_ADMIN': 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
          'LOGIN_TEACHER': 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…',
          'LOGIN_STUDENT': 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨',
          'REGISTER_STUDENT': 'ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯'
        };

        return (
          <div className="flex items-center justify-center min-h-[70vh]">
            <Card className="w-full max-w-md animate-fade-in-up">
              <h2 className="text-2xl font-bold text-center text-secondary mb-6">{titles[view]}</h2>
              
              {/* Alert for Firebase Config */}
              {(firebaseConfig.apiKey === "YOUR_API_KEY_HERE" || !firebaseConfig.apiKey) && (
                 <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 text-xs">
                    <strong className="font-bold">ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø·ÙˆØ±:</strong>
                    <span className="block sm:inline"> Ù„Ù… ÙŠØªÙ… Ø±Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù„Ù† ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„Ù…Ù„Ù firebase-config.js.</span>
                 </div>
              )}

              {view === 'REGISTER_STUDENT' && (
                <Input label="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" name="name" value={formData.name} onChange={handleChange} placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
              )}
              {(view !== 'LOGIN_ADMIN') && (
                <Input label={view === 'REGISTER_STUDENT' ? 'Ø§Ø®ØªØ± ÙƒÙˆØ¯ Ù„Ù„Ø¯Ø®ÙˆÙ„' : 'ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„'} name="code" value={formData.code} onChange={handleChange} />
              )}
              <Input label="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" type="password" name="password" value={formData.password} onChange={handleChange} />
              {view === 'REGISTER_STUDENT' && (
                <Input label="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" type="password" name="confirmPassword" value={formData.confirmPassword} onChange={handleChange} />
              )}
              {error && <div className="text-red-500 text-center mb-4 text-sm font-bold">{error}</div>}
              {success && <div className="text-green-500 text-center mb-4 text-sm font-bold">{success}</div>}
              <div className="mt-6 space-y-3">
                {view === 'LOGIN_ADMIN' && <Button fullWidth onClick={handleAdminLogin} disabled={loading}>{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...' : 'Ø¯Ø®ÙˆÙ„'}</Button>}
                {view === 'LOGIN_TEACHER' && <Button fullWidth onClick={handleTeacherLogin} disabled={loading}>{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...' : 'Ø¯Ø®ÙˆÙ„'}</Button>}
                {view === 'LOGIN_STUDENT' && <Button fullWidth onClick={handleStudentLogin} disabled={loading}>{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...' : 'Ø¯Ø®ÙˆÙ„'}</Button>}
                {view === 'REGISTER_STUDENT' && <Button fullWidth onClick={handleStudentRegister} disabled={loading}>{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...' : 'ØªØ³Ø¬ÙŠÙ„'}</Button>}
                <Button fullWidth variant="secondary" onClick={() => onNavigate('HOME')}>Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</Button>
                {view === 'LOGIN_STUDENT' && (
                  <div className="text-center mt-2">
                    <button className="text-primary text-sm underline" onClick={() => onNavigate('REGISTER_STUDENT')}>Ù„ÙŠØ³ Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ØŸ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
                  </div>
                )}
              </div>
            </Card>
          </div>
        );
      };

      // --- ADMIN PANEL ---
      const AdminPanel = ({ onLogout }) => {
        const [activeTab, setActiveTab] = useState('dashboard');
        const [records, setRecords] = useState([]);
        const [teachers, setTeachers] = useState({});
        const [students, setStudents] = useState([]);
        const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);
        const [filterTeacher, setFilterTeacher] = useState('');
        const [newTeacher, setNewTeacher] = useState({ name: '', code: '', password: '', email: '' });
        const [pwdData, setPwdData] = useState({ old: '', new: '', confirm: '' });
        const [selectedStudentLogs, setSelectedStudentLogs] = useState(null);
        const [loading, setLoading] = useState(false);

        const refreshData = async () => {
          setLoading(true);
          const [rec, teach, stud] = await Promise.all([
             api.getAttendance(),
             api.getTeachers(),
             api.getStudents()
          ]);
          setRecords(rec);
          setTeachers(teach);
          setStudents(stud);
          setLoading(false);
        };

        useEffect(() => { refreshData(); }, []);

        const filteredRecords = records.filter(r => {
          return (filterDate ? r.date === filterDate : true) && (filterTeacher ? r.teacherCode === filterTeacher : true);
        });

        const stats = {
          total: filteredRecords.length,
          present: filteredRecords.filter(r => r.status === 'present').length,
          absent: filteredRecords.filter(r => r.status === 'absent').length,
        };

        const handleAddTeacher = async () => {
          if (!newTeacher.name || !newTeacher.code) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          setLoading(true);
          await api.saveTeacher({ ...newTeacher, students: [] });
          setNewTeacher({ name: '', code: '', password: '', email: '' });
          await refreshData();
          setLoading(false);
          alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…');
        };

        const handleDeleteTeacher = async (code) => { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) { setLoading(true); await api.deleteTeacher(code); await refreshData(); setLoading(false); } };
        const handleDeleteStudent = async (id) => { if(confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) { setLoading(true); await api.deleteStudent(id); await refreshData(); setLoading(false); } };

        const handleExportCSV = () => {
          let csv = '\uFEFFØ§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù…Ø¹Ù„Ù…,Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª\n';
          filteredRecords.forEach(r => {
            const teacherName = teachers[r.teacherCode]?.name || r.teacherCode;
            const status = r.status === 'present' ? 'Ø­Ø§Ø¶Ø±' : 'ØºØ§Ø¦Ø¨';
            csv += `${r.date},"${teacherName}","${r.studentName}","${status}","${(r.notes || '').replace(/"/g, '""')}"\n`;
          });
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `attendance_${filterDate}.csv`; link.click();
        };

        const handleExportStudentLogsCSV = async () => {
          setLoading(true);
          const allData = await api.exportData();
          const studentMap = allData.students.reduce((acc, s) => { if(s.code) acc[s.code] = s.name; return acc; }, {});
          
          let csv = '\uFEFFØ§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨,Ø§Ù„ÙƒÙˆØ¯,Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯,Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©,Ø§Ù„ØªØ³Ù…ÙŠØ¹,Ø§Ù„Ù‡Ø¯Ù,Ù…Ù„Ø§Ø­Ø¸Ø§Øª\n';
          
          allData.studentLogs.forEach(log => {
             const name = studentMap[log.studentCode] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
             csv += `"${log.dateDisplay}","${name}","${log.studentCode}","${(log.newMemorizing || '').replace(/"/g, '""')}","${(log.review || '').replace(/"/g, '""')}","${log.listening}","${(log.newTarget || '').replace(/"/g, '""')}","${(log.notes || '').replace(/"/g, '""')}"\n`;
          });
          
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `student_logs_${new Date().toISOString().split('T')[0]}.csv`; link.click();
          setLoading(false);
        };

        const handleChangePassword = async () => {
          const currentPwd = await api.getAdminPassword();
          if (pwdData.old !== currentPwd) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø®Ø·Ø£');
          if (pwdData.new.length < 4 || pwdData.new !== pwdData.confirm) return alert('Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
          await api.setAdminPassword(pwdData.new);
          setPwdData({ old: '', new: '', confirm: '' });
          alert('ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ù†Ø¬Ø§Ø­'); onLogout();
        };
        
        const loadStudentLogs = async (student) => {
           if(student.code) {
             setLoading(true);
             const logs = await api.getStudentLogs(student.code);
             setSelectedStudentLogs({ student, logs });
             setLoading(false);
           } else alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯'); 
        };

        return (
          <div className="pb-20">
            {loading && <div className="fixed inset-0 bg-white/50 z-[200] flex items-center justify-center"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div></div>}
            <div className="bg-white p-6 rounded-2xl shadow-sm mb-6 flex flex-col justify-between items-center gap-4 text-center">
              <div><h2 className="text-2xl font-bold text-secondary">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2><p className="text-primary mt-1">{new Date().toLocaleDateString('ar-EG')}</p></div>
              <Button variant="danger" onClick={onLogout}>Ø®Ø±ÙˆØ¬</Button>
            </div>
            <div className="flex flex-wrap gap-2 mb-6 justify-center">
              {['dashboard','teachers','students','reports','settings'].map(tab => (
                <Button key={tab} variant={activeTab === tab ? 'primary' : 'secondary'} onClick={() => setActiveTab(tab)} className="text-sm px-3 capitalize">
                  {tab === 'dashboard' ? 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : tab === 'teachers' ? 'Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†' : tab === 'students' ? 'Ø§Ù„Ø·Ù„Ø§Ø¨' : tab === 'reports' ? 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' : 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'}
                </Button>
              ))}
            </div>
            {activeTab === 'dashboard' && (
              <>
                <Card className="mb-6">
                  <div className="flex flex-col gap-4">
                    <Input label="Ø§Ù„ØªØ§Ø±ÙŠØ®" type="date" value={filterDate} onChange={e => setFilterDate(e.target.value)} />
                    <Select label="Ø§Ù„Ù…Ø¹Ù„Ù…" value={filterTeacher} onChange={e => setFilterTeacher(e.target.value)}>
                      <option value="">Ø§Ù„ÙƒÙ„</option>
                      {Object.values(teachers).map(t => <option key={t.code} value={t.code}>{t.name}</option>)}
                    </Select>
                    <Button onClick={refreshData} fullWidth>ØªØ­Ø¯ÙŠØ«</Button>
                  </div>
                </Card>
                <div className="grid grid-cols-3 gap-2 mb-6">
                  <StatCard label="Ø§Ù„Ø³Ø¬Ù„Ø§Øª" value={stats.total} icon={FileText} colorClass="text-blue-600" />
                  <StatCard label="Ø­Ø§Ø¶Ø±" value={stats.present} icon={UserCheck} colorClass="text-green-600" />
                  <StatCard label="ØºØ§Ø¦Ø¨" value={stats.absent} icon={UserX} colorClass="text-red-600" />
                </div>
                
                <Card title="Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ">
                  <div className="space-y-3 max-h-[500px] overflow-y-auto custom-scrollbar">
                    {filteredRecords.length === 0 ? (
                      <div className="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>
                    ) : (
                      filteredRecords.slice().reverse().map((record, index) => {
                        const teacherName = teachers[record.teacherCode]?.name || record.teacherCode;
                        return (
                          <div key={index} className="border-b last:border-0 pb-3 mb-3 last:mb-0 last:pb-0">
                            <div className="flex justify-between items-start mb-1">
                              <span className="font-bold text-gray-800">{record.studentName}</span>
                              <span className={`text-xs px-2 py-1 rounded font-bold ${record.status === 'present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {record.status === 'present' ? 'Ø­Ø§Ø¶Ø±' : 'ØºØ§Ø¦Ø¨'}
                              </span>
                            </div>
                            <div className="text-sm text-gray-500 flex justify-between">
                              <span>ğŸ‘¤ {teacherName}</span>
                              <span>ğŸ“… {record.date}</span>
                            </div>
                            {record.notes && (
                              <div className="mt-1 text-xs bg-yellow-50 text-yellow-800 p-2 rounded">
                                ğŸ“ {record.notes}
                              </div>
                            )}
                          </div>
                        );
                      })
                    )}
                  </div>
                </Card>

                <div className="fixed bottom-14 left-0 right-0 p-4 flex justify-center z-30 pointer-events-none">
                   <Button onClick={handleExportCSV} variant="accent" className="pointer-events-auto shadow-lg"><Download className="w-4 h-4 inline ml-2" /> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± (CSV)</Button>
                </div>
              </>
            )}
            {activeTab === 'teachers' && (
              <div className="space-y-6">
                <Card title="Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…">
                  <Input label="Ø§Ù„Ø§Ø³Ù…" value={newTeacher.name} onChange={e => setNewTeacher({...newTeacher, name: e.target.value})} />
                  <Input label="Ø§Ù„ÙƒÙˆØ¯" value={newTeacher.code} onChange={e => setNewTeacher({...newTeacher, code: e.target.value})} />
                  <Input label="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" type="password" value={newTeacher.password} onChange={e => setNewTeacher({...newTeacher, password: e.target.value})} />
                  <Button fullWidth onClick={handleAddTeacher}>Ø¥Ø¶Ø§ÙØ©</Button>
                </Card>
                <Card title="Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†">
                   <div className="space-y-4 max-h-[500px] overflow-y-auto custom-scrollbar">
                     {Object.values(teachers).map(t => (
                       <div key={t.code} className="p-4 border rounded-lg flex justify-between items-center bg-gray-50">
                         <div><div className="font-bold text-secondary">{t.name}</div><div className="text-sm text-gray-500">{t.code}</div></div>
                         <Button className="p-2 h-10 w-10 flex items-center justify-center" variant="danger" onClick={() => handleDeleteTeacher(t.code)}><Trash2 className="w-4 h-4" /></Button>
                       </div>
                     ))}
                   </div>
                </Card>
              </div>
            )}
            {activeTab === 'students' && (
              <Card title="Ø§Ù„Ø·Ù„Ø§Ø¨">
                  <div className="space-y-3 max-h-[600px] overflow-y-auto custom-scrollbar">
                     {students.map(s => (
                       <div key={s.id} className="p-3 border rounded-lg bg-gray-50">
                         <div className="flex justify-between items-start mb-2">
                            <div><div className="font-bold text-secondary">{s.name}</div><div className="text-xs text-gray-500">{s.code}</div></div>
                            <Button className="p-2 h-8 w-8 flex items-center justify-center" variant="danger" onClick={() => handleDeleteStudent(s.id)}><Trash2 className="w-4 h-4" /></Button>
                         </div>
                         <Button fullWidth className="text-sm py-2 mt-2" variant="primary" onClick={() => loadStudentLogs(s)}><Eye className="w-4 h-4 inline ml-1" /> Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª</Button>
                       </div>
                     ))}
                   </div>
              </Card>
            )}
            {activeTab === 'reports' && (
              <Card title="Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±">
                <div className="space-y-4">
                  <Button onClick={handleExportStudentLogsCSV} variant="primary" fullWidth><Download className="ml-2 w-4 h-4" /> ÙŠÙˆÙ…ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (Excel)</Button>
                </div>
              </Card>
            )}
            {activeTab === 'settings' && (
               <Card title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
                  <Input label="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" type="password" value={pwdData.old} onChange={e => setPwdData({...pwdData, old: e.target.value})} />
                  <Input label="Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" type="password" value={pwdData.new} onChange={e => setPwdData({...pwdData, new: e.target.value})} />
                  <Input label="ØªØ£ÙƒÙŠØ¯" type="password" value={pwdData.confirm} onChange={e => setPwdData({...pwdData, confirm: e.target.value})} />
                  <Button onClick={handleChangePassword} variant="primary" fullWidth className="mt-2">Ø­ÙØ¸</Button>
               </Card>
            )}
            {selectedStudentLogs && (
              <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <Card className="w-full max-w-md max-h-[80vh] flex flex-col bg-white" title={`ÙŠÙˆÙ…ÙŠØ§Øª: ${selectedStudentLogs.student.name}`}>
                   <div className="overflow-y-auto flex-1 custom-scrollbar p-1 space-y-3">
                     {selectedStudentLogs.logs.length===0?<div className="text-center py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙŠÙˆÙ…ÙŠØ§Øª</div>:selectedStudentLogs.logs.slice().reverse().map((log, idx)=>(
                       <div key={idx} className="bg-gray-50 p-3 rounded-xl border">
                          <div className="font-bold text-primary mb-2 border-b pb-1">ğŸ“… {log.dateDisplay}</div>
                          <div className="text-sm space-y-1">
                             <div><span className="text-gray-500">Ø§Ù„Ø­ÙØ¸:</span> {log.newMemorizing}</div>
                             <div><span className="text-gray-500">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</span> {log.review}</div>
                             <div><span className="text-gray-500">Ø§Ù„Ù‡Ø¯Ù:</span> {log.newTarget}</div>
                             {log.notes && <div className="text-xs text-yellow-700 bg-yellow-50 p-1 rounded mt-1">{log.notes}</div>}
                          </div>
                       </div>
                     ))}
                   </div>
                   <Button fullWidth variant="secondary" onClick={() => setSelectedStudentLogs(null)} className="mt-4">Ø¥ØºÙ„Ø§Ù‚</Button>
                </Card>
              </div>
            )}
          </div>
        );
      };

      // --- TEACHER PANEL ---
      const TeacherPanel = ({ teacher, onLogout }) => {
        const [currentTeacher, setCurrentTeacher] = useState(teacher);
        const [attendance, setAttendance] = useState({});
        const [showManageStudents, setShowManageStudents] = useState(false);
        const [showChangePwd, setShowChangePwd] = useState(false);
        const [newStudent, setNewStudent] = useState({ name: '', id: '' });
        const [newPwd, setNewPwd] = useState('');
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          const load = async () => {
             const teachers = await api.getTeachers();
             const updated = teachers[teacher.code];
             if (updated) {
               setCurrentTeacher(updated);
               const init = {}; updated.students?.forEach(s => init[s.name] = { status: null, notes: '' });
               setAttendance(init);
             }
          }
          load();
        }, [teacher.code]);

        const handleStatus = (name, status) => setAttendance(p => ({ ...p, [name]: { ...p[name], status: p[name]?.status === status ? null : status } }));
        const handleNote = (name, notes) => setAttendance(p => ({ ...p, [name]: { ...p[name], notes } }));
        
        const saveAttendance = async () => {
          const records = Object.entries(attendance).filter(([_, d]) => d.status).map(([n, d]) => ({
            id: `${Date.now()}-${Math.random()}`, teacherCode: currentTeacher.code, studentName: n, status: d.status, notes: d.notes, date: new Date().toISOString().split('T')[0]
          }));
          if (!records.length) return alert('Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø©');
          setLoading(true);
          await api.saveAttendanceBatch(records); 
          setLoading(false);
          alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); onLogout();
        };

        const handleAddStudent = async () => {
          if(!newStudent.name||!newStudent.id) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©');
          setLoading(true);
          const t = { ...currentTeacher }; if(!t.students) t.students=[];
          if(t.students.some(s=>s.id===newStudent.id)) { setLoading(false); return alert('Ù…ÙˆØ¬ÙˆØ¯'); }
          t.students.push(newStudent); 
          await api.saveTeacher(t); 
          setCurrentTeacher(t); 
          setNewStudent({name:'',id:''}); 
          setLoading(false);
          alert('ØªÙ…');
        };

        const handleDeleteStudent = async (studentId) => {
            if(confirm('Ø­Ø°ÙØŸ')){
                setLoading(true);
                const t={...currentTeacher};
                t.students=t.students.filter(x=>x.id!==studentId);
                await api.saveTeacher(t);
                setCurrentTeacher(t);
                setLoading(false);
            }
        };

        const handleChangePwd = async () => {
          if(newPwd.length<4) return alert('Ù‚ØµÙŠØ±Ø©');
          setLoading(true);
          const t={...currentTeacher, password:newPwd}; 
          await api.saveTeacher(t); 
          setCurrentTeacher(t); 
          setNewPwd(''); 
          setLoading(false);
          alert('ØªÙ…'); setShowChangePwd(false);
        };

        return (
          <div className="pb-24">
            {loading && <div className="fixed inset-0 bg-white/50 z-[200] flex items-center justify-center"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div></div>}
            <Card className="mb-6 sticky top-4 z-40 border-green-100 flex justify-between items-center">
              <div><h2 className="text-xl font-bold text-secondary">Ø§Ù„Ø­Ø¶ÙˆØ±</h2><div className="text-sm">{currentTeacher.name}</div></div>
              <div className="flex gap-2">
                <Button variant="secondary" onClick={()=>setShowChangePwd(true)} className="p-2"><Key className="w-4 h-4"/></Button>
                <Button variant="accent" onClick={()=>setShowManageStudents(true)} className="px-3 text-sm">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</Button>
              </div>
            </Card>
            <div className="space-y-4">
              {currentTeacher.students?.map(s => {
                  const d = attendance[s.name] || { status: null, notes: '' };
                  return (
                    <div key={s.id} className="bg-white rounded-xl p-4 shadow-sm border flex flex-col md:flex-row gap-4 items-center">
                      <div className="flex-1 w-full text-right"><div className="font-bold text-lg">{s.name}</div><input type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." className="w-full mt-2 p-2 border rounded bg-gray-50" value={d.notes} onChange={e=>handleNote(s.name, e.target.value)} /></div>
                      <div className="flex gap-2 w-full md:w-auto">
                        <button onClick={()=>handleStatus(s.name, 'absent')} className={`flex-1 px-4 py-3 rounded font-bold border ${d.status==='absent'?'bg-red-500 text-white':'bg-red-50 text-red-500'}`}>ØºØ§Ø¦Ø¨</button>
                        <button onClick={()=>handleStatus(s.name, 'present')} className={`flex-1 px-4 py-3 rounded font-bold border ${d.status==='present'?'bg-green-500 text-white':'bg-green-50 text-green-500'}`}>Ø­Ø§Ø¶Ø±</button>
                      </div>
                    </div>
                  );
              })}
            </div>
            <div className="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-top flex gap-4 z-50">
              <Button variant="danger" onClick={onLogout} className="flex-1">Ø®Ø±ÙˆØ¬</Button>
              <Button onClick={saveAttendance} className="flex-[2]">Ø­ÙØ¸</Button>
            </div>
            {showManageStudents && (
              <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <Card className="w-full max-w-lg" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨">
                  <div className="bg-gray-50 p-4 rounded mb-4">
                      <Input label="Ø§Ù„Ø§Ø³Ù…" value={newStudent.name} onChange={e=>setNewStudent({...newStudent, name:e.target.value})} />
                      <Input label="Ø§Ù„Ù‡ÙˆÙŠØ©" value={newStudent.id} onChange={e=>setNewStudent({...newStudent, id:e.target.value})} />
                      <Button fullWidth onClick={handleAddStudent} variant="accent">Ø¥Ø¶Ø§ÙØ©</Button>
                  </div>
                  <div className="max-h-60 overflow-y-auto space-y-2">
                     {currentTeacher.students?.map(s=>(<div key={s.id} className="flex justify-between p-2 border bg-white"><span>{s.name}</span><button onClick={() => handleDeleteStudent(s.id)} className="text-red-500"><Trash2 className="w-4 h-4"/></button></div>))}
                  </div>
                  <Button fullWidth variant="secondary" onClick={()=>setShowManageStudents(false)} className="mt-4">Ø¥ØºÙ„Ø§Ù‚</Button>
                </Card>
              </div>
            )}
            {showChangePwd && (
              <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <Card title="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
                  <Input label="Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" type="password" value={newPwd} onChange={e=>setNewPwd(e.target.value)} />
                  <div className="flex gap-2 mt-4"><Button fullWidth variant="secondary" onClick={()=>setShowChangePwd(false)}>Ø¥Ù„ØºØ§Ø¡</Button><Button fullWidth onClick={handleChangePwd}>Ø­ÙØ¸</Button></div>
                </Card>
              </div>
            )}
          </div>
        );
      };

      // --- STUDENT PANEL ---
      const StudentPanel = ({ student, onLogout }) => {
        const [logs, setLogs] = useState([]);
        const [form, setForm] = useState({ newMemorizing: '', review: '', listening: '', newTarget: '', notes: '' });
        const [showChangePwd, setShowChangePwd] = useState(false);
        const [newPwd, setNewPwd] = useState('');
        const [loading, setLoading] = useState(false);

        useEffect(() => { 
            const load = async () => {
                if(student.code) {
                    const l = await api.getStudentLogs(student.code);
                    setLogs(l);
                }
            };
            load();
        }, [student.code]);

        const handleSubmit = async () => {
          if (!form.newMemorizing || !form.review || !form.listening || !form.newTarget) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          if (!student.code) return alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯');
          setLoading(true);
          const rec = { ...form, date: new Date().toISOString(), dateDisplay: new Date().toLocaleDateString('ar-EG') };
          await api.saveStudentLog(student.code, rec);
          setLogs([rec, ...logs]);
          setForm({ newMemorizing: '', review: '', listening: '', newTarget: '', notes: '' });
          setLoading(false);
          alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
        };

        const handleChangePwd = async () => {
           if(newPwd.length<4) return alert('Ù‚ØµÙŠØ±Ø©');
           setLoading(true);
           await api.updateStudent({ ...student, password: newPwd });
           setNewPwd(''); 
           setLoading(false);
           alert('ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±'); onLogout();
        };

        return (
          <div className="pb-20">
             {loading && <div className="fixed inset-0 bg-white/50 z-[200] flex items-center justify-center"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div></div>}
            <Card className="mb-6 bg-gradient-to-r from-green-50 to-white flex justify-between">
              <div><h2 className="text-2xl font-bold text-secondary">Ù…Ø±Ø­Ø¨Ø§Ù‹ {student.name}</h2><div className="text-sm">Ø§Ù„ÙƒÙˆØ¯: {student.code}</div></div>
              <Button variant="secondary" onClick={()=>setShowChangePwd(true)} className="p-2"><Key className="w-5 h-5"/></Button>
            </Card>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ§Øª">
                <Input label="ğŸ“– Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯" value={form.newMemorizing} onChange={e=>setForm({...form, newMemorizing:e.target.value})} />
                <Input label="ğŸ”„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" value={form.review} onChange={e=>setForm({...form, review:e.target.value})} />
                <Select label="ğŸ¤ Ø§Ù„ØªØ³Ù…ÙŠØ¹" value={form.listening} onChange={e=>setForm({...form, listening:e.target.value})}><option value="">--</option><option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option><option value="Ù„Ø§">Ù„Ø§</option><option value="Ø¬Ø²Ø¦ÙŠ">Ø¬Ø²Ø¦ÙŠ</option></Select>
                <Input label="ğŸ“ Ø§Ù„Ù‡Ø¯Ù" value={form.newTarget} onChange={e=>setForm({...form, newTarget:e.target.value})} />
                <div className="mb-4"><label className="block mb-2 text-right">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea className="w-full border-2 p-3 rounded" value={form.notes} onChange={e=>setForm({...form, notes:e.target.value})} /></div>
                <Button fullWidth onClick={handleSubmit}>Ø­ÙØ¸</Button>
              </Card>
              <Card title="Ø§Ù„Ø³Ø¬Ù„" className="max-h-[800px] flex flex-col">
                 <div className="overflow-y-auto flex-1 custom-scrollbar space-y-4 pr-2">
                    {logs.length===0 && <div className="text-center py-10 text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>}
                    {logs.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).map((log, i) => (
                      <div key={i} className="bg-gray-50 rounded-xl p-4 border hover:border-green-200 transition-colors">
                        <div className="font-bold text-primary mb-2 border-b pb-1">ğŸ“… {log.dateDisplay}</div>
                        <div className="grid grid-cols-2 gap-2 text-sm">
                          <div><span className="font-bold">Ø§Ù„Ø­ÙØ¸:</span> {log.newMemorizing}</div>
                          <div><span className="font-bold">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</span> {log.review}</div>
                          <div><span className="font-bold">Ø§Ù„ØªØ³Ù…ÙŠØ¹:</span> {log.listening}</div>
                          <div><span className="font-bold">Ø§Ù„Ù‡Ø¯Ù:</span> {log.newTarget}</div>
                        </div>
                        {log.notes && <div className="mt-2 text-xs bg-white p-2 border rounded">{log.notes}</div>}
                      </div>
                    ))}
                 </div>
              </Card>
            </div>
            <div className="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-top flex justify-center z-50">
              <Button variant="danger" onClick={onLogout} className="px-8 flex gap-2"><LogOut className="w-4 h-4"/> Ø®Ø±ÙˆØ¬</Button>
            </div>
            {showChangePwd && (
              <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <Card title="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
                  <Input label="Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" type="password" value={newPwd} onChange={e=>setNewPwd(e.target.value)} />
                  <div className="flex gap-2 mt-4"><Button fullWidth variant="secondary" onClick={()=>setShowChangePwd(false)}>Ø¥Ù„ØºØ§Ø¡</Button><Button fullWidth onClick={handleChangePwd}>Ø­ÙØ¸</Button></div>
                </Card>
              </div>
            )}
          </div>
        );
      };

      // ==========================================
      // MAIN APP COMPONENT
      // ==========================================
      
      const App = () => {
        const [view, setView] = useState('HOME');
        const [session, setSession] = useState(null);
        const [imageError, setImageError] = useState(false);

        const handleLoginSuccess = (userType, data) => {
          setSession({ type: userType, data });
          if (userType === 'admin') setView('DASHBOARD_ADMIN');
          if (userType === 'teacher') setView('DASHBOARD_TEACHER');
          if (userType === 'student') setView('DASHBOARD_STUDENT');
        };

        const handleLogout = () => { setSession(null); setView('HOME'); };

        const renderContent = () => {
          switch (view) {
            case 'HOME': return <Home onNavigate={setView} />;
            case 'LOGIN_TEACHER': case 'LOGIN_ADMIN': case 'LOGIN_STUDENT': case 'REGISTER_STUDENT':
              return <Login view={view} onNavigate={setView} onLoginSuccess={handleLoginSuccess} />;
            case 'DASHBOARD_ADMIN': return session?.type === 'admin' ? <AdminPanel onLogout={handleLogout} /> : <Home onNavigate={setView} />;
            case 'DASHBOARD_TEACHER': return session?.type === 'teacher' ? <TeacherPanel teacher={session.data} onLogout={handleLogout} /> : <Home onNavigate={setView} />;
            case 'DASHBOARD_STUDENT': return session?.type === 'student' ? <StudentPanel student={session.data} onLogout={handleLogout} /> : <Home onNavigate={setView} />;
            default: return <Home onNavigate={setView} />;
          }
        };

        return (
          <div className="min-h-screen relative bg-gray-100 flex justify-center items-start pt-0 md:pt-4">
            <div className="w-full max-w-md bg-gradient-to-br from-bgStart to-bgEnd min-h-screen shadow-2xl relative flex flex-col md:rounded-xl overflow-hidden border-x border-gray-200">
              <header className="sticky top-0 z-50 bg-secondary text-white shadow-md">
                <div className="px-4 py-3 flex items-center gap-3 w-full">
                  <div className="shrink-0">
                    {imageError ? (
                       <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center border border-white/30"><User className="w-6 h-6 text-white/90" /></div>
                    ) : (
                      <img src="sheikh.jpg" alt="Ø§Ù„Ø´ÙŠØ®" className="w-10 h-10 rounded-full object-cover border border-white/40 shadow-sm bg-white" onError={(e) => { setImageError(true); e.currentTarget.style.display = 'none'; }} />
                    )}
                  </div>
                  <h1 className="text-sm font-bold whitespace-nowrap overflow-hidden text-ellipsis flex-1 leading-relaxed pt-1">Ù…ÙƒØªØ¨ ØªØ­ÙÙŠØ¸ Ø§Ù„Ø´ÙŠØ® Ø³Ø¹Ø¯ Ø¨Ù† Ù…Ø­Ù…ÙˆØ¯ Ø£Ø¨Ùˆ Ù†ÙˆØ§Ø±Ø¬</h1>
                </div>
              </header>

              <main className="flex-1 px-4 py-6 pb-24 overflow-x-hidden">{renderContent()}</main>

              <footer className="absolute bottom-0 left-0 w-full bg-white/95 backdrop-blur-md shadow-[0_-4px_20px_rgba(0,0,0,0.08)] py-3 px-6 z-40 border-t border-gray-100">
                <div className="flex justify-center items-center gap-3 text-sm font-bold text-gray-700">
                  <span className="text-gray-500 text-xs">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§:</span>
                  <a href="https://wa.me/201060936428" target="_blank" className="flex items-center gap-2 text-green-600 bg-green-50 px-3 py-1.5 rounded-full">
                    <svg viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.272-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.67-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.076 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421-7.403h-.004a9.87 9.87 0 00-4.951 1.263l-.355.192-.368-.06 1.41 5.209.9.003c1.231-1.187 2.927-1.9 4.773-1.9 4.97 0 9.005 4.028 9.005 9.009 0 4.983-4.032 9.015-9.009 9.015-4.981 0-9.01-4.032-9.01-9.015 0-1.946.648-3.835 1.8-5.36l.134-.341-.086-.368-1.41-5.209-.37-.056.192-.355A9.87 9.87 0 0112.051 2c5.495 0 9.973 4.478 9.973 9.973 0 5.495-4.478 9.973-9.973 9.973-5.495 0-9.973-4.478-9.973-9.973 0-2.15.697-4.243 1.977-6.004"/></svg>
                    01060936428
                  </a>
                </div>
              </footer>
            </div>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
